package com.code.service.log;

import java.util.Date;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.CachePut;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.code.dao.log.NoticeLogDao;
import com.code.entity.log.NoticeLog;
import com.code.tool.MsgUtil;

@Service("noticeLogService")
@Transactional(readOnly=false)
public class NoticeLogService{

	@Autowired
	private NoticeLogDao noticeLogDao;
	
	public void checkNoticeLog(){
		List<NoticeLog> list = noticeLogDao.findNeedSend(0);
		if(null!=list&&!list.isEmpty()){
			for(NoticeLog log :list){
				MsgUtil msgUtil = new MsgUtil(log.getMobilePhone(),log.getContent());
				String result = msgUtil.send();
				int status = 1;
				if(!"ok".equals(result)){
					status = -1;
				}
				updateOne(log.getId(),result,status);
			}
		}
	}
	
	@CachePut(value = "entity:NoticeLog", key="'cpy:user:'+#id+''")
	@Transactional(readOnly=false)
	public void updateOne(Long id,String result,Integer status){
		NoticeLog noticeLog = noticeLogDao.findOne(id);
		noticeLog.setLastUpdateDate(new Date());
		noticeLog.setResult(result);
		noticeLog.setStatus(status);
		noticeLogDao.save(noticeLog);
	}
}
